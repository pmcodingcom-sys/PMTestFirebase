<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Profile Hub | Supabase</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root { --primary: #3ecf8e; --secondary: #2f3437; --bg: #f3f4f6; }
        body { font-family: 'Kanit', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        
        /* Layout หลัก */
        .main-container { max-width: 900px; margin: 0 auto; display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px; }
        @media (max-width: 768px) { .main-container { grid-template-columns: 1fr; } }

        /* การ์ดฟอร์ม */
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); position: sticky; top: 20px; height: fit-content; }
        .card h2 { margin-top: 0; color: var(--secondary); font-size: 1.5rem; border-bottom: 2px solid var(--primary); display: inline-block; padding-bottom: 5px; }

        /* ฟอร์มกรอกข้อมูล */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: #666; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 10px; font-family: 'Kanit'; box-sizing: border-box; }
        
        /* อัปโหลดรูปประจำตัว */
        .avatar-upload { text-align: center; margin-bottom: 20px; }
        .avatar-preview { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); margin-bottom: 10px; background: #eee; }
        .btn-upload { font-size: 0.8rem; color: var(--primary); cursor: pointer; text-decoration: underline; }

        .btn-save { width: 100%; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 10px; font-size: 1rem; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        .btn-save:hover { background: #34b279; transform: translateY(-2px); }

        /* แสดงผล Profile Card */
        .profile-list { display: grid; gap: 15px; }
        .profile-item { background: white; padding: 15px; border-radius: 15px; display: flex; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: 0.3s; }
        .profile-item:hover { transform: translateX(5px); }
        .profile-info { flex-grow: 1; margin-left: 15px; }
        .profile-info h3 { margin: 0; font-size: 1.1rem; }
        .profile-info p { margin: 2px 0; font-size: 0.85rem; color: #777; }
        .profile-avatar { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; }

        /* Loader */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.7); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div></div>

    <div class="main-container">
        <div class="card">
            <h2><i class="fa-solid fa-user-plus"></i> เพิ่มสมาชิก</h2>
            <div class="avatar-upload">
                <img id="imgPreview" src="https://via.placeholder.com/100" class="avatar-preview">
                <label class="btn-upload" for="fileInput">เปลี่ยนรูปโปรไฟล์</label>
                <input type="file" id="fileInput" hidden accept="image/*" onchange="previewImg()">
            </div>

            <div class="form-group">
                <label>ชื่อ-นามสกุล</label>
                <input type="text" id="fullName" placeholder="สมชาย ใจดี">
            </div>
            <div class="form-group">
                <label>ชื่อเล่น</label>
                <input type="text" id="nickName" placeholder="ชาย">
            </div>
            <div class="form-group">
                <label>ตำแหน่ง</label>
                <select id="position">
                    <option value="Manager">Manager</option>
                    <option value="Developer">Developer</option>
                    <option value="Designer">Designer</option>
                    <option value="Marketing">Marketing</option>
                </select>
            </div>
            <div class="form-group">
                <label>เบอร์โทรศัพท์</label>
                <input type="tel" id="phone" placeholder="08x-xxx-xxxx">
            </div>
            <div class="form-group">
                <label>อีเมล</label>
                <input type="email" id="email" placeholder="example@mail.com">
            </div>

            <button class="btn-save" onclick="saveProfile()"><i class="fa-solid fa-cloud-arrow-up"></i> บันทึกข้อมูล</button>
        </div>

        <div class="profile-list" id="profileList">
            </div>
    </div>

    <script>
        // 1. ตั้งค่า Supabase
        const SUPABASE_URL = 'https://ebritvdvmkpfilbehpaj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVicml0dmR2bWtwZmlsYmVocGFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMTM4NTMsImV4cCI6MjA4NTc4OTg1M30.xF0tZqQtw3NDAvRgM7JXvboiKjkMVnt3K4ZeAycbEy0';
        const supabase_DB = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const toggleLoader = (show) => document.getElementById('loader').style.display = show ? 'flex' : 'none';

        function previewImg() {
            const file = document.getElementById('fileInput').files[0];
            if (file) document.getElementById('imgPreview').src = URL.createObjectURL(file);
        }

        // --- [CREATE] บันทึกข้อมูล ---
        async function saveProfile() {
            const fullName = document.getElementById('fullName').value;
            const nickName = document.getElementById('nickName').value;
            const position = document.getElementById('position').value;
            const phone = document.getElementById('phone').value;
            const email = document.getElementById('email').value;
            const file = document.getElementById('fileInput').files[0];

            if (!fullName || !phone) return Swal.fire('เตือน', 'กรุณากรอกชื่อและเบอร์โทร', 'warning');

            toggleLoader(true);
            try {
                let imageUrl = "https://ui-avatars.com/api/?name=User&background=random";
                if (file) {
                    const fileName = Date.now() + "_" + file.name;
                    const { data: uploadData, error: uploadError } = await supabase_DB.storage
                        .from('images') // ชื่อ Bucket ที่คุณสร้าง
                        .upload(fileName, file);
                    if (uploadError) throw uploadError;
                    const { data: urlData } = supabase_DB.storage.from('images').getPublicUrl(fileName);
                    imageUrl = urlData.publicUrl;
                }

                const { error } = await supabase_DB.from('profiles').insert([{ 
                    full_name: fullName, nickname: nickName, position, phone, email, image_url: imageUrl 
                }]);
                
                if (error) throw error;

                Swal.fire('สำเร็จ', 'บันทึกข้อมูลแล้ว', 'success');
                resetForm();
                fetchProfiles();
            } catch (err) {
                Swal.fire('Error', err.message, 'error');
            } finally {
                toggleLoader(false);
            }
        }

        // --- [READ] ดึงข้อมูล ---
        async function fetchProfiles() {
            const { data, error } = await supabase_DB.from('profiles').select('*').order('created_at', { ascending: false });
            if (error) return console.error(error);

            const container = document.getElementById('profileList');
            container.innerHTML = data.map(item => `
                <div class="profile-item">
                    <img src="${item.image_url}" class="profile-avatar">
                    <div class="profile-info">
                        <h3>${item.full_name} (${item.nickname})</h3>
                        <p><i class="fa-solid fa-briefcase"></i> ${item.position}</p>
                        <p><i class="fa-solid fa-phone"></i> ${item.phone} | <i class="fa-solid fa-envelope"></i> ${item.email}</p>
                    </div>
                    <button onclick="deleteProfile(${item.id})" style="border:none; color:#ff4d4d; background:none; cursor:pointer;">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                </div>
            `).join('');
        }

        // --- [DELETE] ลบข้อมูล ---
        async function deleteProfile(id) {
            const res = await Swal.fire({ title: 'ลบข้อมูลนี้?', icon: 'warning', showCancelButton: true });
            if (res.isConfirmed) {
                toggleLoader(true);
                await supabase_DB.from('profiles').delete().eq('id', id);
                fetchProfiles();
                toggleLoader(false);
            }
        }

        function resetForm() {
            document.querySelectorAll('input').forEach(i => i.value = "");
            document.getElementById('imgPreview').src = "https://ui-avatars.com/api/?name=User&background=random";
        }

        fetchProfiles(); // โหลดครั้งแรก
    </script>
</body>
</html>
