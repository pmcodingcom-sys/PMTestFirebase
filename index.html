<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Member Dashboard | 2026 Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: 'Kanit', sans-serif; }
        .radial-bg {
            background: radial-gradient(circle at center, #fb923c, #ef4444, #b91c1c);
        }
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="radial-bg min-h-screen pb-10">

    <div id="loader" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div class="w-12 h-12 border-4 border-white border-t-orange-500 rounded-full animate-spin"></div>
    </div>

    <div class="max-w-md mx-auto px-4 pt-8">
        
        <div class="text-white mb-6">
            <h1 class="text-3xl font-semibold mb-2">Dashboard</h1>
            <p class="opacity-80 text-sm">ยินดีต้อนรับสู่ระบบจัดการสมาชิกส่วนตัว</p>
            
            <div class="grid grid-cols-2 gap-4 mt-6">
                <div class="bg-white/20 backdrop-blur-md rounded-2xl p-4 border border-white/30">
                    <p class="text-xs opacity-80">สมาชิกทั้งหมด</p>
                    <h2 id="stat-total" class="text-3xl font-bold">0</h2>
                </div>
                <div class="bg-white/20 backdrop-blur-md rounded-2xl p-4 border border-white/30">
                    <p class="text-xs opacity-80">ตำแหน่งยอดนิยม</p>
                    <h2 id="stat-top-role" class="text-xl font-bold truncate">-</h2>
                </div>
            </div>
        </div>

        <div class="glass rounded-3xl p-6 shadow-2xl mb-8 border border-white/20">
            <div class="flex items-center gap-3 mb-4">
                <div class="bg-orange-100 text-orange-600 p-2 rounded-xl">
                    <i class="fa-solid fa-user-plus text-xl"></i>
                </div>
                <h2 class="text-xl font-semibold text-gray-800">เพิ่มสมาชิกใหม่</h2>
            </div>

            <div class="space-y-4">
                <div class="flex flex-col items-center mb-4">
                    <div class="relative group">
                        <img id="imgPreview" src="https://ui-avatars.com/api/?name=User&background=random" class="w-24 h-24 rounded-full object-cover border-4 border-orange-100 shadow-md">
                        <label for="fileInput" class="absolute bottom-0 right-0 bg-orange-500 text-white p-2 rounded-full cursor-pointer shadow-lg hover:bg-orange-600 transition">
                            <i class="fa-solid fa-camera text-xs"></i>
                        </label>
                    </div>
                    <input type="file" id="fileInput" hidden accept="image/*" onchange="previewImg()">
                </div>

                <div class="grid grid-cols-1 gap-3">
                    <input type="text" id="fullName" placeholder="ชื่อ-นามสกุล" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-orange-500 outline-none transition">
                    <div class="flex gap-2">
                        <input type="text" id="nickName" placeholder="ชื่อเล่น" class="w-1/2 px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-orange-500 outline-none transition">
                        <select id="position" class="w-1/2 px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-orange-500 outline-none transition bg-white">
                            <option value="Manager">Manager</option>
                            <option value="Developer">Developer</option>
                            <option value="Designer">Designer</option>
                            <option value="Marketing">Marketing</option>
                        </select>
                    </div>
                    <input type="tel" id="phone" placeholder="เบอร์โทรศัพท์" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-orange-500 outline-none transition">
                    <input type="email" id="email" placeholder="อีเมล" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-orange-500 outline-none transition">
                </div>

                <button onclick="saveProfile()" class="w-full bg-gradient-to-r from-orange-500 to-red-600 text-white font-medium py-4 rounded-2xl shadow-lg shadow-orange-500/30 active:scale-95 transition-all">
                    บันทึกข้อมูลสมาชิก
                </button>
            </div>
        </div>

        <div class="flex justify-between items-center mb-4 px-2">
            <h3 class="text-white font-medium">รายชื่อสมาชิก</h3>
            <span class="text-white/60 text-xs" id="last-update">อัปเดตล่าสุด: -</span>
        </div>

        <div id="profileList" class="space-y-4">
            </div>

    </div>

    <script>
        const SUPABASE_URL = 'https://ebritvdvmkpfilbehpaj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVicml0dmR2bWtwZmlsYmVocGFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMTM4NTMsImV4cCI6MjA4NTc4OTg1M30.xF0tZqQtw3NDAvRgM7JXvboiKjkMVnt3K4ZeAycbEy0';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const toggleLoader = (show) => document.getElementById('loader').style.display = show ? 'flex' : 'none';

        function previewImg() {
            const file = document.getElementById('fileInput').files[0];
            if (file) document.getElementById('imgPreview').src = URL.createObjectURL(file);
        }

        async function saveProfile() {
            const fullName = document.getElementById('fullName').value;
            const nickName = document.getElementById('nickName').value;
            const position = document.getElementById('position').value;
            const phone = document.getElementById('phone').value;
            const email = document.getElementById('email').value;
            const file = document.getElementById('fileInput').files[0];

            if (!fullName || !phone) return Swal.fire('ข้อมูลไม่ครบ', 'กรุณากรอกชื่อและเบอร์โทร', 'warning');

            toggleLoader(true);
            try {
                let imageUrl = `https://ui-avatars.com/api/?name=${fullName}&background=random`;
                if (file) {
                    const fileName = Date.now() + "_" + file.name;
                    const { data: uploadData, error: uploadError } = await _supabase.storage.from('images').upload(fileName, file);
                    if (uploadError) throw uploadError;
                    const { data: urlData } = _supabase.storage.from('images').getPublicUrl(fileName);
                    imageUrl = urlData.publicUrl;
                }

                const { error } = await _supabase.from('profiles').insert([{ 
                    full_name: fullName, nickname: nickName, position, phone, email, image_url: imageUrl 
                }]);
                if (error) throw error;

                Swal.fire({ icon: 'success', title: 'สำเร็จ!', text: 'บันทึกสมาชิกเรียบร้อย', showConfirmButton: false, timer: 1500 });
                resetForm();
                fetchProfiles();
            } catch (err) {
                Swal.fire('Error', err.message, 'error');
            } finally { toggleLoader(false); }
        }

        async function fetchProfiles() {
            const { data, error } = await _supabase.from('profiles').select('*').order('id', { ascending: false });
            if (error) return console.error(error);

            // Update Dashboard Stats
            document.getElementById('stat-total').innerText = data.length;
            const roles = data.map(i => i.position);
            const topRole = roles.sort((a,b) => roles.filter(v => v===a).length - roles.filter(v => v===b).length).pop();
            document.getElementById('stat-top-role').innerText = topRole || '-';
            document.getElementById('last-update').innerText = `อัปเดต: ${new Date().toLocaleTimeString()}`;

            const container = document.getElementById('profileList');
            container.innerHTML = data.map(item => `
                <div class="glass rounded-2xl p-4 flex items-center justify-between border border-white/20 shadow-lg animate-fadeIn">
                    <div class="flex items-center gap-4">
                        <img src="${item.image_url}" class="w-14 h-14 rounded-2xl object-cover shadow-sm">
                        <div>
                            <h4 class="font-semibold text-gray-800">${item.full_name} (${item.nickname})</h4>
                            <p class="text-xs text-orange-600 font-medium">${item.position}</p>
                            <p class="text-[10px] text-gray-500 mt-1"><i class="fa-solid fa-phone"></i> ${item.phone}</p>
                        </div>
                    </div>
                    <button onclick="deleteProfile(${item.id})" class="text-red-400 hover:text-red-600 p-2 transition">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                </div>
            `).join('');
        }

        async function deleteProfile(id) {
            const res = await Swal.fire({ title: 'ยืนยันการลบ?', text: "ข้อมูลสมาชิกจะหายไปถาวร", icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444', cancelButtonColor: '#6b7280', confirmButtonText: 'ลบเลย!', cancelButtonText: 'ยกเลิก' });
            if (res.isConfirmed) {
                toggleLoader(true);
                await _supabase.from('profiles').delete().eq('id', id);
                fetchProfiles();
                toggleLoader(false);
            }
        }

        function resetForm() {
            document.querySelectorAll('input').forEach(i => i.value = "");
            document.getElementById('imgPreview').src = "https://ui-avatars.com/api/?name=User&background=random";
            document.getElementById('fileInput').value = "";
        }

        fetchProfiles();
    </script>
</body>
</html>
